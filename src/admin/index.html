<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LeadGen Admin ‚Äî Gadgeek</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { brand: { 600:'#4f46e5', 700:'#4338ca' } } } }
    }
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    [x-cloak] { display: none !important; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen" x-data="app()" x-init="init()">

<!-- Toasts -->
<div class="fixed top-5 right-5 z-50 flex flex-col gap-2" style="min-width:300px" x-cloak>
  <template x-for="t in toasts" :key="t.id">
    <div x-show="t.visible"
         x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-x-3" x-transition:enter-end="opacity-100 translate-x-0"
         x-transition:leave="transition ease-in duration-150" x-transition:leave-end="opacity-0 translate-x-3"
         class="flex items-center gap-3 px-4 py-3 rounded-xl shadow-2xl text-sm font-semibold border"
         :class="t.type==='success'?'bg-emerald-950 border-emerald-800 text-emerald-300':t.type==='error'?'bg-red-950 border-red-800 text-red-300':'bg-amber-950 border-amber-800 text-amber-300'">
      <span x-text="t.type==='success'?'‚úì':t.type==='error'?'‚úï':'!'"></span>
      <span x-text="t.message"></span>
    </div>
  </template>
</div>

<div class="flex min-h-screen">

  <!-- Sidebar -->
  <aside class="w-56 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 sticky top-0 h-screen overflow-hidden">
    <div class="px-4 py-5 border-b border-slate-800 flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center text-white font-black text-sm shadow-lg shadow-indigo-900/50 shrink-0">‚ö°</div>
      <div>
        <div class="text-white font-bold text-sm">LeadGen</div>
        <div class="text-slate-500 text-xs">Gadgeek Engine</div>
      </div>
    </div>

    <nav class="flex-1 px-3 py-3 flex flex-col gap-0.5">
      <template x-for="item in navItems" :key="item.page">
        <button @click="navigate(item.page)" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all w-full text-left"
                :class="page===item.page?'bg-indigo-600 text-white shadow-lg shadow-indigo-900/40':'text-slate-400 hover:text-white hover:bg-slate-800'">
          <span class="text-sm" x-text="item.icon"></span>
          <span x-text="item.label" class="flex-1"></span>
          <span x-show="item.page==='leads'&&(stats.new_leads||0)>0"
                class="text-xs font-bold bg-white/20 px-1.5 py-0.5 rounded-full" x-text="stats.new_leads"></span>
        </button>
      </template>
    </nav>

    <div class="px-4 py-3 border-t border-slate-800">
      <div class="text-xs text-slate-700">
        Pitch: <span class="text-slate-500" x-text="queues.pitch?.waiting||0"></span> ¬∑
        FU: <span class="text-slate-500" x-text="queues.followup?.delayed||0"></span>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 overflow-auto">

    <!-- ===== DASHBOARD ===== -->
    <div x-show="page==='dashboard'" x-cloak class="p-8">
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="text-2xl font-bold text-white">Dashboard</h1>
          <p class="text-slate-500 text-sm mt-1">Your lead pipeline overview</p>
        </div>
        <div class="flex gap-3">
          <button @click="triggerScan()" :disabled="scanning"
            class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold border border-slate-700 text-slate-300 hover:bg-slate-800 transition-all disabled:opacity-40">
            <span :class="scanning?'inline-block animate-spin':''">‚Üª</span>
            <span x-text="scanning?'Scanning...':'Run Scan'"></span>
          </button>
          <button @click="triggerPitchBatch()"
            class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold bg-indigo-600 hover:bg-indigo-500 text-white transition-all shadow-lg shadow-indigo-900/40">
            ‚úâ Pitch Batch
          </button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5">
          <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Total Leads</div>
          <div class="text-4xl font-black text-white" x-text="stats.total||0"></div>
          <div class="text-xs text-emerald-400 mt-2 font-semibold" x-text="'+'+(stats.found_today||0)+' today'"></div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5">
          <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">In Pipeline</div>
          <div class="text-4xl font-black text-indigo-400" x-text="stats.in_pipeline||0"></div>
          <div class="text-xs text-slate-600 mt-2" x-text="(stats.new_leads||0)+' awaiting pitch'"></div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5">
          <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Replied</div>
          <div class="text-4xl font-black text-emerald-400" x-text="stats.replied||0"></div>
          <div class="text-xs text-slate-600 mt-2" x-text="(stats.converted||0)+' converted'"></div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5">
          <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Revenue</div>
          <div class="text-4xl font-black text-amber-400" x-text="'‚Çπ'+Number(stats.revenue||0).toLocaleString('en-IN')"></div>
          <div class="text-xs text-slate-600 mt-2">from conversions</div>
        </div>
      </div>

      <!-- Website Status -->
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-slate-900 border border-red-900/30 rounded-2xl p-5 flex items-center gap-4">
          <div class="w-12 h-12 rounded-xl bg-red-900/30 flex items-center justify-center text-xl shrink-0">üö´</div>
          <div>
            <div class="text-2xl font-black text-red-400" x-text="stats.no_website||0"></div>
            <div class="text-sm font-semibold text-white">No Website</div>
            <div class="text-xs text-slate-600 mt-0.5">Never had one</div>
          </div>
        </div>
        <div class="bg-slate-900 border border-orange-900/30 rounded-2xl p-5 flex items-center gap-4">
          <div class="w-12 h-12 rounded-xl bg-orange-900/30 flex items-center justify-center text-xl shrink-0">üíÄ</div>
          <div>
            <div class="text-2xl font-black text-orange-400" x-text="stats.dead_website||0"></div>
            <div class="text-sm font-semibold text-white">Dead Website</div>
            <div class="text-xs text-slate-600 mt-0.5">Broken / unreachable</div>
          </div>
        </div>
        <div class="bg-slate-900 border border-yellow-900/30 rounded-2xl p-5 flex items-center gap-4">
          <div class="w-12 h-12 rounded-xl bg-yellow-900/30 flex items-center justify-center text-xl shrink-0">üÖø</div>
          <div>
            <div class="text-2xl font-black text-yellow-400" x-text="stats.parked_website||0"></div>
            <div class="text-sm font-semibold text-white">Parked Website</div>
            <div class="text-xs text-slate-600 mt-0.5">Placeholder page</div>
          </div>
        </div>
      </div>

      <!-- Activity Feed -->
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
        <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Recent Activity</div>
        <div x-show="recentActivity.length===0" class="py-10 text-center text-slate-700 text-sm">No activity yet ‚Äî run a scan to get started</div>
        <div class="space-y-0.5">
          <template x-for="item in recentActivity" :key="item.id">
            <div class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-slate-800/60 transition-colors group">
              <div class="w-7 h-7 rounded-lg flex items-center justify-center text-xs shrink-0"
                   :class="item.action.includes('reply')||item.action.includes('converted')?'bg-emerald-900/60 text-emerald-400':item.action.includes('fail')?'bg-red-900/60 text-red-400':item.action.includes('pitch')?'bg-indigo-900/60 text-indigo-400':'bg-slate-800 text-slate-500'"
                   x-text="activityIcon(item.action)"></div>
              <div class="flex-1 min-w-0 flex items-center gap-2">
                <span class="text-sm text-slate-300" x-text="formatAction(item.action)"></span>
                <span x-show="item.business_name" class="text-sm text-slate-600 truncate" x-text="'‚Äî '+item.business_name"></span>
              </div>
              <span class="text-xs text-slate-700 shrink-0" x-text="timeAgo(item.created_at)"></span>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- ===== LEADS ===== -->
    <div x-show="page==='leads'" x-cloak class="p-8">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-bold text-white">Leads</h1>
          <p class="text-slate-500 text-sm mt-1" x-text="leadsTotal+' total'"></p>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 mb-5 grid grid-cols-4 gap-3">
        <div>
          <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Status</div>
          <select class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  x-model="leadFilter.status" @change="loadLeads()">
            <option value="">All</option>
            <option value="new">New</option>
            <option value="pitched">Pitched</option>
            <option value="followed_up_1">Follow-up 1</option>
            <option value="followed_up_2">Follow-up 2</option>
            <option value="followed_up_3">Follow-up 3</option>
            <option value="replied">Replied</option>
            <option value="converted">Converted</option>
            <option value="archived">Archived</option>
          </select>
        </div>
        <div>
          <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Website</div>
          <select class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  x-model="leadFilter.website_status" @change="loadLeads()">
            <option value="">All Types</option>
            <option value="none">No Website</option>
            <option value="dead">Dead</option>
            <option value="parked">Parked</option>
          </select>
        </div>
        <div>
          <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Category</div>
          <input class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-slate-600"
                 type="text" placeholder="e.g. restaurant" x-model="leadFilter.category" @input.debounce.400="loadLeads()" />
        </div>
        <div>
          <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Location</div>
          <input class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-slate-600"
                 type="text" placeholder="e.g. Chennai" x-model="leadFilter.location" @input.debounce.400="loadLeads()" />
        </div>
      </div>

      <!-- Table -->
      <div class="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-slate-800">
              <th class="text-left px-5 py-3.5 text-xs font-bold text-slate-500 uppercase tracking-wider">Business</th>
              <th class="text-left px-4 py-3.5 text-xs font-bold text-slate-500 uppercase tracking-wider">Category</th>
              <th class="text-left px-4 py-3.5 text-xs font-bold text-slate-500 uppercase tracking-wider">Website</th>
              <th class="text-left px-4 py-3.5 text-xs font-bold text-slate-500 uppercase tracking-wider">Rating</th>
              <th class="text-left px-4 py-3.5 text-xs font-bold text-slate-500 uppercase tracking-wider">Status</th>
              <th class="text-left px-4 py-3.5 text-xs font-bold text-slate-500 uppercase tracking-wider">Found</th>
              <th class="px-4 py-3.5"></th>
            </tr>
          </thead>
          <tbody>
            <tr x-show="leadsLoading"><td colspan="7" class="text-center py-16 text-slate-600">Loading...</td></tr>
            <tr x-show="!leadsLoading&&leads.length===0"><td colspan="7" class="text-center py-16 text-slate-700">No leads match filters</td></tr>
            <template x-for="lead in leads" :key="lead.id">
              <tr class="border-b border-slate-800/50 hover:bg-slate-800/30 cursor-pointer transition-colors" @click="openLead(lead)">
                <td class="px-5 py-3.5">
                  <div class="font-semibold text-slate-100" x-text="lead.business_name"></div>
                  <div class="text-xs text-slate-600 mt-0.5" x-text="lead.location"></div>
                </td>
                <td class="px-4 py-3.5 text-xs text-slate-500" x-text="lead.category"></td>
                <td class="px-4 py-3.5">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-bold border"
                        :class="lead.website_status==='none'?'bg-red-900/30 text-red-400 border-red-800/40':lead.website_status==='dead'?'bg-orange-900/30 text-orange-400 border-orange-800/40':'bg-yellow-900/30 text-yellow-400 border-yellow-800/40'"
                        x-text="lead.website_status==='none'?'üö´ None':lead.website_status==='dead'?'üíÄ Dead':'üÖø Parked'"></span>
                </td>
                <td class="px-4 py-3.5">
                  <span x-show="lead.rating" class="text-amber-400 text-xs font-bold" x-text="'‚≠ê '+lead.rating"></span>
                  <span x-show="lead.review_count>0" class="text-slate-700 text-xs ml-1" x-text="'('+lead.review_count+')'"></span>
                  <span x-show="!lead.rating" class="text-slate-700">‚Äî</span>
                </td>
                <td class="px-4 py-3.5">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-bold border" :class="statusClass(lead.status)" x-text="formatStatus(lead.status)"></span>
                </td>
                <td class="px-4 py-3.5 text-xs text-slate-600" x-text="formatDate(lead.created_at)"></td>
                <td class="px-4 py-3.5 text-indigo-500 text-xs font-semibold">View ‚Üí</td>
              </tr>
            </template>
          </tbody>
        </table>
        <div class="flex items-center justify-between px-5 py-3.5 border-t border-slate-800">
          <span class="text-xs text-slate-600" x-text="'Showing '+leads.length+' of '+leadsTotal"></span>
          <div class="flex gap-2">
            <button @click="leadsPage--;loadLeads()" :disabled="leadsPage===0"
              class="px-3 py-1.5 text-xs font-bold rounded-lg border border-slate-700 text-slate-400 hover:bg-slate-800 disabled:opacity-30 transition-all">‚Üê Prev</button>
            <button @click="leadsPage++;loadLeads()" :disabled="(leadsPage+1)*leadsPageSize>=leadsTotal"
              class="px-3 py-1.5 text-xs font-bold rounded-lg border border-slate-700 text-slate-400 hover:bg-slate-800 disabled:opacity-30 transition-all">Next ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== ACTIVITY ===== -->
    <div x-show="page==='activity'" x-cloak class="p-8">
      <h1 class="text-2xl font-bold text-white mb-2">Activity Feed</h1>
      <p class="text-slate-500 text-sm mb-6">Every system action in real-time</p>
      <div class="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden">
        <div x-show="activity.length===0" class="py-16 text-center text-slate-700 text-sm">No activity yet</div>
        <div class="divide-y divide-slate-800/50">
          <template x-for="item in activity" :key="item.id">
            <div class="flex items-start gap-4 px-5 py-3.5 hover:bg-slate-800/30 transition-colors">
              <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm shrink-0 mt-0.5"
                   :class="item.action.includes('reply')||item.action.includes('converted')?'bg-emerald-900/50 text-emerald-400':item.action.includes('fail')?'bg-red-900/50 text-red-400':'bg-slate-800 text-slate-400'"
                   x-text="activityIcon(item.action)"></div>
              <div class="flex-1">
                <div class="text-sm font-semibold text-slate-200" x-text="formatAction(item.action)"></div>
                <div class="text-xs text-slate-600 mt-0.5">
                  <span x-show="item.business_name" x-text="item.business_name+' ¬∑ '"></span>
                  <span x-text="new Date(item.created_at).toLocaleString('en-IN')"></span>
                </div>
                <pre x-show="item.details&&Object.keys(item.details||{}).length>0"
                     class="mt-1.5 text-xs text-slate-600 bg-slate-800/50 px-2.5 py-1.5 rounded-lg overflow-x-auto"
                     x-text="JSON.stringify(item.details,null,2)"></pre>
              </div>
            </div>
          </template>
        </div>
        <div class="p-4 border-t border-slate-800">
          <button @click="loadMoreActivity()" class="w-full py-2 text-sm font-semibold text-slate-500 hover:text-slate-200 hover:bg-slate-800 rounded-lg transition-all">Load More</button>
        </div>
      </div>
    </div>

    <!-- ===== SCAN HISTORY ===== -->
    <div x-show="page==='scans'" x-cloak class="p-8">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-bold text-white">Scan History</h1>
          <p class="text-slate-500 text-sm mt-1">Past Google Places scans</p>
        </div>
        <button @click="triggerScan()" :disabled="scanning"
          class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold bg-indigo-600 hover:bg-indigo-500 text-white transition-all disabled:opacity-40">
          <span :class="scanning?'inline-block animate-spin':''">‚Üª</span>
          <span x-text="scanning?'Scanning...':'Run Scan Now'"></span>
        </button>
      </div>
      <div class="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-slate-800">
              <th class="text-left px-5 py-3.5 text-xs font-bold text-slate-500 uppercase tracking-wider">Started</th>
              <th class="text-left px-4 py-3.5 text-xs font-bold text-slate-500 uppercase tracking-wider">Status</th>
              <th class="text-left px-4 py-3.5 text-xs font-bold text-slate-500 uppercase tracking-wider">Found</th>
              <th class="text-left px-4 py-3.5 text-xs font-bold text-slate-500 uppercase tracking-wider">New</th>
              <th class="text-left px-4 py-3.5 text-xs font-bold text-slate-500 uppercase tracking-wider">Skipped</th>
              <th class="text-left px-4 py-3.5 text-xs font-bold text-slate-500 uppercase tracking-wider">Duration</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800/50">
            <tr x-show="scans.length===0"><td colspan="6" class="text-center py-16 text-slate-700">No scans yet</td></tr>
            <template x-for="scan in scans" :key="scan.id">
              <tr class="hover:bg-slate-800/30 transition-colors">
                <td class="px-5 py-3.5 text-xs text-slate-400" x-text="new Date(scan.started_at).toLocaleString('en-IN')"></td>
                <td class="px-4 py-3.5">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-bold border"
                        :class="scan.status==='completed'?'bg-emerald-900/30 text-emerald-400 border-emerald-800/40':scan.status==='failed'?'bg-red-900/30 text-red-400 border-red-800/40':'bg-blue-900/30 text-blue-400 border-blue-800/40'"
                        x-text="scan.status"></span>
                </td>
                <td class="px-4 py-3.5 font-bold text-slate-200" x-text="scan.leads_found||0"></td>
                <td class="px-4 py-3.5 font-bold text-emerald-400" x-text="scan.leads_new||0"></td>
                <td class="px-4 py-3.5 text-slate-600" x-text="scan.leads_skipped||0"></td>
                <td class="px-4 py-3.5 text-xs text-slate-600"
                    x-text="scan.completed_at?Math.round((new Date(scan.completed_at)-new Date(scan.started_at))/60000)+'m':'‚Äî'"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ===== SETTINGS ===== -->
    <div x-show="page==='settings'" x-cloak class="p-8">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-bold text-white">Settings</h1>
          <p class="text-slate-500 text-sm mt-1">Configure everything from here ‚Äî no code needed</p>
        </div>
        <button @click="saveSettings()" :disabled="savingSettings"
          class="flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-semibold bg-indigo-600 hover:bg-indigo-500 text-white transition-all disabled:opacity-50 shadow-lg shadow-indigo-900/40">
          <span x-text="savingSettings?'Saving...':'Save Settings'"></span>
        </button>
      </div>

      <div class="space-y-5">

        <!-- API Keys -->
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
          <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-5">üîë API Keys</div>
          <div class="space-y-4">
            <template x-for="field in apiKeyFields" :key="field.key">
              <div class="grid grid-cols-3 gap-3 items-end">
                <div class="col-span-2">
                  <label class="block text-xs font-semibold text-slate-400 mb-1.5" x-text="field.label"></label>
                  <input class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm font-mono text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-slate-600"
                         type="password" :placeholder="field.placeholder" x-model="s[field.key]" />
                  <p x-show="field.hint" class="text-xs text-slate-600 mt-1" x-text="field.hint"></p>
                </div>
                <button x-show="field.test" @click="testService(field.test)"
                  class="px-4 py-2.5 rounded-lg text-sm font-semibold border border-slate-700 text-slate-300 hover:bg-slate-800 transition-all">Test</button>
              </div>
            </template>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-semibold text-slate-400 mb-1.5">Twilio Account SID</label>
                <input class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm font-mono text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-slate-600"
                       type="password" x-model="s.twilio_sid" placeholder="ACxxx..." />
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-400 mb-1.5">Twilio Auth Token</label>
                <div class="flex gap-2">
                  <input class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm font-mono text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-slate-600"
                         type="password" x-model="s.twilio_token" placeholder="Token" />
                  <button @click="testService('twilio')" class="px-3 py-2.5 rounded-lg text-sm font-semibold border border-slate-700 text-slate-300 hover:bg-slate-800 transition-all shrink-0">Test</button>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-1.5">Twilio From Number (SMS fallback)</label>
              <input class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-slate-600"
                     type="text" x-model="s.twilio_from_number" placeholder="+91xxxxxxxxxx" />
            </div>
          </div>
        </div>

        <!-- Email Config -->
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
          <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-5">üìß Email Configuration</div>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-1.5">From Email</label>
              <input class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-slate-600"
                     type="email" x-model="s.from_email" placeholder="hello@yourdomain.com" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-1.5">From Name</label>
              <input class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-slate-600"
                     type="text" x-model="s.from_name" placeholder="Your Agency" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-1.5">Morning Briefing Email</label>
              <input class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-slate-600"
                     type="email" x-model="s.briefing_email" placeholder="you@domain.com" />
            </div>
          </div>
        </div>

        <!-- Scan Config -->
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
          <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-5">üîç Scan Configuration</div>
          <div class="space-y-4">
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-2">Scan Areas (Cities)</label>
              <div class="flex flex-wrap gap-2 min-h-9 mb-2">
                <template x-for="(area,idx) in scanAreas" :key="idx">
                  <span class="inline-flex items-center gap-1.5 bg-slate-800 border border-slate-700 text-slate-200 text-xs font-semibold px-3 py-1.5 rounded-lg">
                    <span x-text="area"></span>
                    <button @click="scanAreas.splice(idx,1)" class="text-slate-600 hover:text-red-400 transition-colors font-black">√ó</button>
                  </span>
                </template>
              </div>
              <div class="flex gap-2">
                <input class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-slate-600"
                       type="text" x-model="newScanArea" placeholder="e.g. Mumbai, India" @keydown.enter="addScanArea()" />
                <button @click="addScanArea()" class="px-4 py-2.5 rounded-lg text-sm font-semibold bg-slate-800 border border-slate-700 text-slate-300 hover:bg-slate-700 transition-all">+ Add</button>
              </div>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-2">Business Categories</label>
              <div class="flex flex-wrap gap-2 min-h-9 mb-2">
                <template x-for="(cat,idx) in scanCategories" :key="idx">
                  <span class="inline-flex items-center gap-1.5 bg-indigo-900/30 border border-indigo-800/40 text-indigo-300 text-xs font-semibold px-3 py-1.5 rounded-lg">
                    <span x-text="cat"></span>
                    <button @click="scanCategories.splice(idx,1)" class="text-indigo-700 hover:text-red-400 transition-colors font-black">√ó</button>
                  </span>
                </template>
              </div>
              <div class="flex gap-2">
                <input class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-slate-600"
                       type="text" x-model="newScanCategory" placeholder="e.g. gym, salon, clinic" @keydown.enter="addScanCategory()" />
                <button @click="addScanCategory()" class="px-4 py-2.5 rounded-lg text-sm font-semibold bg-slate-800 border border-slate-700 text-slate-300 hover:bg-slate-700 transition-all">+ Add</button>
              </div>
            </div>
            <div class="grid grid-cols-4 gap-4">
              <div>
                <label class="block text-xs font-semibold text-slate-400 mb-1.5">Max Results / Search</label>
                <input class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       type="number" x-model="s.scan_max_results" min="1" max="60" />
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-400 mb-1.5">Scan Time (IST)</label>
                <input class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       type="time" x-model="s.scan_time" />
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-400 mb-1.5">Scan Delay (ms)</label>
                <input class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       type="number" x-model="s.scan_delay_ms" min="100" step="100" />
              </div>
              <div class="flex items-end pb-2.5">
                <label class="flex items-center gap-2.5 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 rounded accent-indigo-500 shrink-0" x-model="s.scan_only_new" />
                  <span class="text-sm text-slate-300 font-medium leading-tight">Skip existing (saves API cost)</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Follow-up + Pitch (2 col) -->
        <div class="grid grid-cols-2 gap-5">
          <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
            <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-5">üìÖ Follow-up Schedule</div>
            <div class="space-y-3.5">
              <template x-for="fu in [{key:'followup_1_days',label:'Follow-up #1 ‚Äî Check-in'},{key:'followup_2_days',label:'Follow-up #2 ‚Äî Competitor angle'},{key:'followup_3_days',label:'Follow-up #3 ‚Äî Final + bonus'}]" :key="fu.key">
                <div class="flex items-center justify-between gap-3">
                  <label class="text-sm text-slate-400 flex-1" x-text="fu.label"></label>
                  <div class="flex items-center gap-2 shrink-0">
                    <input class="w-16 bg-slate-800 border border-slate-700 rounded-lg px-2 py-2 text-sm text-center font-bold text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                           type="number" x-model="s[fu.key]" min="1" max="30" />
                    <span class="text-xs text-slate-600">days</span>
                  </div>
                </div>
              </template>
              <p class="text-xs text-slate-700 pt-1">After follow-up #3 + 48h ‚Üí auto-archived</p>
            </div>
          </div>
          <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
            <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-5">üöÄ Pitch Schedule</div>
            <div class="space-y-3.5">
              <div class="flex items-center justify-between gap-3">
                <label class="text-sm text-slate-400">Pitch time (IST)</label>
                <input class="w-28 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       type="time" x-model="s.pitch_time" />
              </div>
              <div class="flex items-center justify-between gap-3">
                <label class="text-sm text-slate-400">Max pitches / day</label>
                <input class="w-28 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       type="number" x-model="s.pitch_batch_size" min="1" max="200" />
              </div>
              <div class="flex items-center justify-between gap-3">
                <label class="text-sm text-slate-400">Delay between pitches</label>
                <div class="flex items-center gap-2 shrink-0">
                  <input class="w-20 bg-slate-800 border border-slate-700 rounded-lg px-2 py-2 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                         type="number" x-model="s.pitch_delay_ms" min="500" step="500" />
                  <span class="text-xs text-slate-600">ms</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- AI Config -->
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
          <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-5">ü§ñ AI Configuration</div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-1.5">OpenRouter Model</label>
              <select class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                      x-model="s.openrouter_model">
                <option value="anthropic/claude-sonnet-4-5">Claude Sonnet 4.5 (Recommended)</option>
                <option value="anthropic/claude-haiku-4-5">Claude Haiku 4.5 (Fast / Cheap)</option>
                <option value="anthropic/claude-opus-4">Claude Opus 4 (Best Quality)</option>
                <option value="openai/gpt-4o">GPT-4o</option>
                <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
                <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-1.5">Max Tokens</label>
              <input class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     type="number" x-model="s.max_tokens" min="200" max="4000" step="100" />
            </div>
          </div>
        </div>

        <!-- Prompt Customization -->
        <div class="bg-slate-900 border border-indigo-900/40 rounded-2xl p-6">
          <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">‚≠ê Prompt Customization</div>
          <p class="text-xs text-slate-600 mb-6">Edit AI prompts without touching code. Business details are always appended automatically.</p>

          <div class="space-y-5">
            <!-- Email -->
            <div class="border border-blue-900/30 rounded-xl p-5" style="background:rgba(23,37,84,0.15)">
              <div class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-4">üìß Email Pitch</div>
              <div class="space-y-3">
                <div>
                  <label class="block text-xs font-semibold text-slate-500 mb-1.5">System Prompt ‚Äî <span class="text-slate-600 font-normal">AI persona & writing style</span></label>
                  <textarea class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2.5 text-xs text-slate-300 font-mono focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-y"
                            rows="3" x-model="s.email_system_prompt"></textarea>
                </div>
                <div>
                  <label class="block text-xs font-semibold text-slate-500 mb-1.5">User Instructions ‚Äî <span class="text-slate-600 font-normal">specific task for each email</span></label>
                  <textarea class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2.5 text-xs text-slate-300 font-mono focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-y"
                            rows="3" x-model="s.email_user_instructions"></textarea>
                </div>
              </div>
            </div>

            <!-- WhatsApp -->
            <div class="border border-emerald-900/30 rounded-xl p-5" style="background:rgba(6,78,59,0.1)">
              <div class="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-4">üí¨ WhatsApp / SMS Pitch</div>
              <div class="space-y-3">
                <div>
                  <label class="block text-xs font-semibold text-slate-500 mb-1.5">System Prompt</label>
                  <textarea class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2.5 text-xs text-slate-300 font-mono focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-y"
                            rows="2" x-model="s.whatsapp_system_prompt"></textarea>
                </div>
                <div>
                  <label class="block text-xs font-semibold text-slate-500 mb-1.5">User Instructions ‚Äî <span class="text-slate-600 font-normal">max 75 words, end with a question</span></label>
                  <textarea class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2.5 text-xs text-slate-300 font-mono focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-y"
                            rows="2" x-model="s.whatsapp_user_instructions"></textarea>
                </div>
              </div>
            </div>

            <!-- Follow-ups -->
            <div class="border border-amber-900/30 rounded-xl p-5" style="background:rgba(120,53,15,0.08)">
              <div class="text-xs font-bold text-amber-400 uppercase tracking-wider mb-4">üìÖ Follow-up Prompts</div>
              <div class="space-y-5">
                <template x-for="n in [1,2,3]" :key="n">
                  <div class="pl-3 border-l-2 border-amber-900/50">
                    <div class="text-xs font-bold text-amber-500 mb-2.5"
                         x-text="n===1?'Follow-up #1 ‚Äî Friendly Check-in':n===2?'Follow-up #2 ‚Äî Competitor Angle':'Follow-up #3 ‚Äî Final + Bonus'"></div>
                    <div class="space-y-2">
                      <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">System Prompt</label>
                        <textarea class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 font-mono focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-y"
                                  rows="2" x-model="s[`followup${n}_system_prompt`]"></textarea>
                      </div>
                      <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">User Instructions</label>
                        <textarea class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 font-mono focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-y"
                                  rows="2" x-model="s[`followup${n}_user_instructions`]"></textarea>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>

        <!-- Automation -->
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
          <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">‚öôÔ∏è Automation</div>
          <div class="divide-y divide-slate-800/50">
            <template x-for="toggle in automationToggles" :key="toggle.key">
              <div class="flex items-center justify-between py-4 first:pt-0 last:pb-0">
                <div>
                  <div class="text-sm font-semibold text-slate-200" x-text="toggle.label"></div>
                  <div class="text-xs text-slate-600 mt-0.5" x-text="toggle.desc"></div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer ml-6 shrink-0">
                  <input type="checkbox" class="sr-only peer" x-model="s[toggle.key]" />
                  <div class="w-11 h-6 rounded-full transition-colors bg-slate-700 peer-checked:bg-indigo-600 relative">
                    <div class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform peer-checked:translate-x-5"
                         :class="s[toggle.key]?'translate-x-5':'translate-x-0'"></div>
                  </div>
                </label>
              </div>
            </template>
          </div>
        </div>

        <div class="flex justify-end pb-4">
          <button @click="saveSettings()" :disabled="savingSettings"
            class="px-8 py-3 rounded-xl text-base font-bold bg-indigo-600 hover:bg-indigo-500 text-white transition-all disabled:opacity-50 shadow-xl shadow-indigo-900/40">
            <span x-text="savingSettings?'Saving...':'Save All Settings'"></span>
          </button>
        </div>

      </div>
    </div>

  </main>
</div>

<!-- Lead Modal -->
<div x-cloak x-show="leadModal" class="fixed inset-0 z-40 flex items-start justify-center p-4 overflow-y-auto" style="background:rgba(0,0,0,0.75)" @click.self="leadModal=false">
  <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-2xl my-8 shadow-2xl"
       x-show="leadModal" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100">
    <template x-if="selectedLead">
      <div>
        <div class="flex items-start justify-between p-6 border-b border-slate-800">
          <div>
            <h2 class="text-lg font-bold text-white" x-text="selectedLead.business_name"></h2>
            <div class="flex flex-wrap items-center gap-2 mt-2">
              <span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-bold border" :class="statusClass(selectedLead.status)" x-text="formatStatus(selectedLead.status)"></span>
              <span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-bold border"
                    :class="selectedLead.website_status==='none'?'bg-red-900/30 text-red-400 border-red-800/40':selectedLead.website_status==='dead'?'bg-orange-900/30 text-orange-400 border-orange-800/40':'bg-yellow-900/30 text-yellow-400 border-yellow-800/40'"
                    x-text="selectedLead.website_status==='none'?'üö´ No Website':selectedLead.website_status==='dead'?'üíÄ Dead Website':'üÖø Parked'"></span>
              <span x-show="selectedLead.rating" class="text-amber-400 text-sm font-bold" x-text="'‚≠ê '+selectedLead.rating+' ('+selectedLead.review_count+')'"></span>
            </div>
          </div>
          <button @click="leadModal=false" class="text-slate-600 hover:text-white text-2xl leading-none transition-colors w-8 h-8 flex items-center justify-center rounded-lg hover:bg-slate-800">√ó</button>
        </div>

        <div class="p-6 space-y-5 max-h-screen overflow-y-auto">
          <div class="grid grid-cols-2 gap-2">
            <template x-for="f in leadFields" :key="f.key">
              <div class="bg-slate-800/40 rounded-xl px-4 py-3" :class="f.full?'col-span-2':''">
                <div class="text-xs font-bold text-slate-600 mb-1" x-text="f.label"></div>
                <div x-show="f.key!=='gmb_url'" class="text-sm text-slate-200" x-text="selectedLead[f.key]||'‚Äî'"></div>
                <div x-show="f.key==='gmb_url'">
                  <a x-show="selectedLead.gmb_url" :href="selectedLead.gmb_url" target="_blank" class="text-indigo-400 hover:text-indigo-300 text-xs underline">View on Google Maps ‚Üí</a>
                  <span x-show="!selectedLead.gmb_url" class="text-slate-600 text-sm">‚Äî</span>
                </div>
              </div>
            </template>
            <div class="bg-slate-800/40 rounded-xl px-4 py-3">
              <div class="text-xs font-bold text-slate-600 mb-1">GMB Photos</div>
              <div class="text-sm" x-text="selectedLead.has_photos?'‚úÖ Yes':'‚ùå No'"></div>
            </div>
          </div>

          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Notes</label>
            <textarea class="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2.5 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"
                      rows="2" x-model="selectedLead.notes" @change="saveNotes(selectedLead)"></textarea>
          </div>

          <div class="flex gap-3 flex-wrap">
            <button x-show="selectedLead.status==='new'" @click="pitchLead(selectedLead)"
              class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold bg-indigo-600 hover:bg-indigo-500 text-white transition-all">‚úâÔ∏è Pitch Now</button>
            <button x-show="!['converted','archived'].includes(selectedLead.status)" @click="promptConvert(selectedLead)"
              class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold bg-emerald-700 hover:bg-emerald-600 text-white transition-all">üí∞ Mark Converted</button>
            <button x-show="!['archived','converted'].includes(selectedLead.status)" @click="archiveLead(selectedLead)"
              class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold border border-slate-700 text-slate-400 hover:bg-slate-800 transition-all">üóÉ Archive</button>
          </div>

          <div x-show="leadMessages.length>0">
            <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Message History</div>
            <div class="space-y-2">
              <template x-for="msg in leadMessages" :key="msg.id">
                <div class="bg-slate-800/40 border border-slate-700/40 rounded-xl p-4">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2 flex-wrap">
                      <span class="px-1.5 py-0.5 rounded text-xs font-bold bg-slate-700 text-slate-300" x-text="msg.message_type.replace(/_/g,' ')"></span>
                      <span class="px-1.5 py-0.5 rounded text-xs font-bold border"
                            :class="msg.channel==='email'?'bg-blue-900/30 text-blue-400 border-blue-800/40':msg.channel==='whatsapp'?'bg-emerald-900/30 text-emerald-400 border-emerald-800/40':'bg-purple-900/30 text-purple-400 border-purple-800/40'"
                            x-text="msg.channel"></span>
                      <span class="px-1.5 py-0.5 rounded text-xs font-bold border"
                            :class="msg.status==='sent'?'bg-emerald-900/30 text-emerald-400 border-emerald-800/40':msg.status==='failed'?'bg-red-900/30 text-red-400 border-red-800/40':'bg-slate-800 text-slate-500 border-slate-700'"
                            x-text="msg.status"></span>
                    </div>
                    <span class="text-xs text-slate-600" x-text="formatDate(msg.created_at)"></span>
                  </div>
                  <div x-show="msg.subject" class="text-xs font-bold text-slate-500 mb-1.5" x-text="'Subject: '+msg.subject"></div>
                  <div class="text-xs text-slate-400 font-mono whitespace-pre-wrap max-h-28 overflow-y-auto leading-relaxed" x-text="msg.body"></div>
                </div>
              </template>
            </div>
          </div>

          <div x-show="leadReplies.length>0">
            <div class="text-xs font-bold text-emerald-500 uppercase tracking-wider mb-3">Replies Received</div>
            <div class="space-y-2">
              <template x-for="reply in leadReplies" :key="reply.id">
                <div class="border border-emerald-900/30 rounded-xl p-4" style="background:rgba(6,78,59,0.1)">
                  <div class="flex items-center justify-between mb-2">
                    <span class="px-1.5 py-0.5 rounded text-xs font-bold bg-emerald-900/40 text-emerald-400 border border-emerald-800/40" x-text="'via '+reply.channel"></span>
                    <span class="text-xs text-slate-600" x-text="formatDate(reply.received_at)"></span>
                  </div>
                  <div class="text-sm text-slate-200" x-text="reply.body"></div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </template>
  </div>
</div>

<!-- Convert Modal -->
<div x-cloak x-show="convertModal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="background:rgba(0,0,0,0.75)" @click.self="convertModal=false">
  <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-sm shadow-2xl"
       x-show="convertModal" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95">
    <h3 class="text-lg font-bold text-white mb-1">üí∞ Mark as Converted</h3>
    <p class="text-slate-500 text-sm mb-5">Enter the contract value for revenue tracking</p>
    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Revenue (‚Çπ)</label>
    <input class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-2xl font-black text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 mb-5"
           type="number" x-model="convertRevenue" placeholder="0" min="0" step="500" />
    <div class="flex gap-3">
      <button @click="confirmConvert()" class="flex-1 py-2.5 rounded-xl text-sm font-bold bg-emerald-700 hover:bg-emerald-600 text-white transition-all">‚úì Confirm</button>
      <button @click="convertModal=false" class="flex-1 py-2.5 rounded-xl text-sm font-bold border border-slate-700 text-slate-400 hover:bg-slate-800 transition-all">Cancel</button>
    </div>
  </div>
</div>

<script>
function app() {
  return {
    page: 'dashboard',
    toasts: [], toastId: 0,
    stats: {}, recentActivity: [], queues: { pitch:{waiting:0}, followup:{delayed:0} },
    scanning: false,
    leads: [], leadsTotal: 0, leadsPage: 0, leadsPageSize: 50, leadsLoading: false,
    leadFilter: { status:'', website_status:'', category:'', location:'' },
    leadModal: false, selectedLead: null, leadMessages: [], leadReplies: [],
    convertModal: false, convertRevenue: '', convertingLead: null,
    activity: [], activityLimit: 50,
    scans: [],
    s: {}, savingSettings: false,
    scanAreas: [], scanCategories: [], newScanArea: '', newScanCategory: '',

    navItems: [
      { page:'dashboard', icon:'‚ñ¶', label:'Dashboard' },
      { page:'leads',     icon:'‚óé', label:'Leads' },
      { page:'activity',  icon:'‚ö°', label:'Activity' },
      { page:'scans',     icon:'‚äô', label:'Scan History' },
      { page:'settings',  icon:'‚öô', label:'Settings' },
    ],

    apiKeyFields: [
      { key:'google_places_key', label:'Google Places API Key', placeholder:'AIza...', test:'google_places', hint:'Enable Places API & Geocoding in Google Cloud Console' },
      { key:'openrouter_key',    label:'OpenRouter API Key',    placeholder:'sk-or-...', test:'openrouter', hint:'' },
      { key:'sendgrid_key',      label:'SendGrid API Key',       placeholder:'SG....', test:'sendgrid', hint:'' },
      { key:'wasender_api_key',  label:'WaSender API Key (WhatsApp primary)', placeholder:'from wasenderapi.com', test:'wasender', hint:'WhatsApp tried first ‚Üí SMS fallback on failure' },
      { key:'wasender_phone_number', label:'WaSender Phone Number', placeholder:'+91xxxxxxxxxx', test:null, hint:'' },
      { key:'slack_webhook_url', label:'Slack Webhook URL', placeholder:'https://hooks.slack.com/...', test:'slack', hint:'' },
    ],

    automationToggles: [
      { key:'auto_scan_enabled',    label:'Enable Daily Scan',       desc:'Runs nightly scan at configured time' },
      { key:'auto_pitch_enabled',   label:'Enable Auto-Pitch',       desc:'Pitches new leads at configured time daily' },
      { key:'auto_followup_enabled',label:'Enable Auto Follow-ups',  desc:'Sends Day 3/5/7 follow-ups automatically' },
      { key:'briefing_enabled',     label:'Enable Morning Briefing', desc:'Pipeline summary to Slack + email at 8 AM IST' },
    ],

    leadFields: [
      { key:'category', label:'Category' },
      { key:'location', label:'Location' },
      { key:'address',  label:'Address', full:true },
      { key:'phone',    label:'Phone' },
      { key:'email',    label:'Email' },
      { key:'gmb_url',  label:'GMB Profile' },
    ],

    async init() {
      await this.loadDashboard();
      setInterval(() => { if (this.page==='dashboard') this.loadDashboard(); }, 30000);
    },

    async navigate(p) {
      this.page = p;
      if (p==='leads') this.loadLeads();
      if (p==='activity') this.loadActivity();
      if (p==='scans') this.loadScans();
      if (p==='settings') this.loadSettings();
    },

    async api(method, path, body) {
      const opts = { method, headers:{'Content-Type':'application/json'} };
      if (body) opts.body = JSON.stringify(body);
      return fetch('/api'+path, opts).then(r=>r.json());
    },

    toast(message, type='success') {
      const id = ++this.toastId;
      this.toasts.push({ id, message, type, visible:true });
      setTimeout(() => { const t=this.toasts.find(x=>x.id===id); if(t) t.visible=false; }, 3500);
      setTimeout(() => { this.toasts=this.toasts.filter(x=>x.id!==id); }, 4200);
    },

    async loadDashboard() {
      try {
        const d = await this.api('GET','/dashboard');
        if (d.ok) { this.stats=d.stats; this.recentActivity=d.activity; this.queues=d.queues; }
      } catch(e) {}
    },

    async triggerScan() {
      this.scanning=true;
      const d = await this.api('POST','/actions/scan');
      this.toast(d.message||'Scan started!', d.ok?'success':'error');
      setTimeout(()=>{ this.scanning=false; this.loadDashboard(); }, 3000);
    },

    async triggerPitchBatch() {
      const d = await this.api('POST','/actions/pitch-batch');
      this.toast(d.message||'Batch started!', d.ok?'success':'error');
    },

    async loadLeads() {
      this.leadsLoading=true;
      const p = new URLSearchParams({ limit:this.leadsPageSize, offset:this.leadsPage*this.leadsPageSize });
      if (this.leadFilter.status) p.set('status',this.leadFilter.status);
      if (this.leadFilter.website_status) p.set('website_status',this.leadFilter.website_status);
      if (this.leadFilter.category) p.set('category',this.leadFilter.category);
      if (this.leadFilter.location) p.set('location',this.leadFilter.location);
      try {
        const d = await fetch('/api/leads?'+p).then(r=>r.json());
        if (d.ok) { this.leads=d.leads; this.leadsTotal=d.total; }
      } finally { this.leadsLoading=false; }
    },

    async openLead(lead) {
      this.selectedLead=lead; this.leadModal=true; this.leadMessages=[]; this.leadReplies=[];
      const d = await this.api('GET','/leads/'+lead.id);
      if (d.ok) { this.selectedLead=d.lead; this.leadMessages=d.messages; this.leadReplies=d.replies; }
    },

    async pitchLead(lead) {
      const d = await this.api('POST','/leads/'+lead.id+'/pitch');
      this.toast(d.ok?'Pitch queued!':d.error, d.ok?'success':'error');
      if (d.ok) { this.leadModal=false; this.loadLeads(); }
    },

    promptConvert(lead) { this.convertingLead=lead; this.convertRevenue=''; this.convertModal=true; },

    async confirmConvert() {
      const d = await this.api('POST','/leads/'+this.convertingLead.id+'/convert',{revenue:this.convertRevenue});
      this.toast(d.ok?'üéâ Converted!':d.error, d.ok?'success':'error');
      this.convertModal=false;
      if (d.ok) { this.leadModal=false; this.loadLeads(); this.loadDashboard(); }
    },

    async archiveLead(lead) {
      if (!confirm('Archive this lead?')) return;
      const d = await this.api('POST','/leads/'+lead.id+'/archive');
      this.toast(d.ok?'Archived':d.error, d.ok?'success':'error');
      if (d.ok) { this.leadModal=false; this.loadLeads(); }
    },

    async saveNotes(lead) { await this.api('PATCH','/leads/'+lead.id+'/notes',{notes:lead.notes}); },

    async loadActivity() {
      const d = await this.api('GET','/activity?limit='+this.activityLimit);
      if (d.ok) this.activity=d.activity;
    },

    async loadMoreActivity() { this.activityLimit+=50; this.loadActivity(); },

    async loadScans() {
      const d = await this.api('GET','/scans');
      if (d.ok) this.scans=d.scans;
    },

    async loadSettings() {
      const d = await this.api('GET','/settings');
      if (!d.ok) return;
      this.s={...d.settings};
      try { this.scanAreas=JSON.parse(this.s.scan_areas||'[]'); } catch { this.scanAreas=[]; }
      try { this.scanCategories=JSON.parse(this.s.scan_categories||'[]'); } catch { this.scanCategories=[]; }
      ['auto_scan_enabled','auto_pitch_enabled','auto_followup_enabled','briefing_enabled','scan_only_new'].forEach(k=>{
        this.s[k]=this.s[k]==='true'||this.s[k]===true;
      });
    },

    addScanArea() {
      const a=this.newScanArea.trim();
      if(a&&!this.scanAreas.includes(a)){ this.scanAreas.push(a); this.newScanArea=''; }
    },

    addScanCategory() {
      const c=this.newScanCategory.trim();
      if(c&&!this.scanCategories.includes(c)){ this.scanCategories.push(c); this.newScanCategory=''; }
    },

    async saveSettings() {
      this.savingSettings=true;
      try {
        this.s.scan_areas=JSON.stringify(this.scanAreas);
        this.s.scan_categories=JSON.stringify(this.scanCategories);
        const d = await this.api('PATCH','/settings',this.s);
        this.toast(d.ok?'Settings saved!':d.error||'Failed', d.ok?'success':'error');
      } catch(e) { this.toast('Error: '+e.message,'error'); }
      finally { this.savingSettings=false; }
    },

    async testService(service) {
      this.toast('Testing '+service+'...','warn');
      const d = await this.api('POST','/settings/test/'+service);
      this.toast(d.ok?'‚úì '+service+' connected!':'‚úó '+(d.error||'Failed'), d.ok?'success':'error');
    },

    statusClass(s) {
      const m = {
        new:          'bg-slate-800 text-slate-400 border-slate-700',
        pitched:      'bg-indigo-900/40 text-indigo-400 border-indigo-800/50',
        followed_up_1:'bg-purple-900/40 text-purple-400 border-purple-800/50',
        followed_up_2:'bg-violet-900/40 text-violet-400 border-violet-800/50',
        followed_up_3:'bg-fuchsia-900/40 text-fuchsia-400 border-fuchsia-800/50',
        replied:      'bg-emerald-900/40 text-emerald-400 border-emerald-800/50',
        converted:    'bg-green-900/40 text-green-400 border-green-800/50',
        archived:     'bg-slate-800/50 text-slate-600 border-slate-800',
      };
      return m[s]||'bg-slate-800 text-slate-400 border-slate-700';
    },

    formatStatus(s) {
      return {new:'New',pitched:'Pitched',followed_up_1:'Follow-up 1',followed_up_2:'Follow-up 2',
              followed_up_3:'Follow-up 3',replied:'Replied',converted:'Converted',archived:'Archived'}[s]||s;
    },

    activityIcon(a) {
      if(a.includes('reply')||a.includes('converted')) return 'üí¨';
      if(a.includes('fail')) return '‚úï';
      if(a.includes('pitch')) return '‚úç';
      if(a.includes('email')) return '‚úâ';
      if(a.includes('scan')||a.includes('found')) return 'üîç';
      if(a.includes('archive')) return 'üóÉ';
      return '‚Ä¢';
    },

    formatAction(a) { return a.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()); },
    formatDate(d) { if(!d)return'‚Äî'; return new Date(d).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}); },
    timeAgo(d) {
      if(!d)return'';
      const m=Math.floor((Date.now()-new Date(d))/60000);
      if(m<1)return'just now'; if(m<60)return m+'m ago';
      const h=Math.floor(m/60); if(h<24)return h+'h ago';
      return Math.floor(h/24)+'d ago';
    },
  };
}
</script>
</body>
</html>